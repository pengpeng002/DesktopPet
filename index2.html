<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Live2D Web Demo</title>
    
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/live2dcubismcore@1.0.0/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent; 
        }
        #canvas { display: block; width: 100%; height: 100%; pointer-events: auto; }
        
        /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        #debug {
            position: absolute; top: 0; left: 0; color: cyan; 
            font-family: monospace; font-size: 16px; background: rgba(0,0,0,0.5); 
            padding: 5px; pointer-events: none;
            z-index: 10;
        }

        /* æ–°å¢ï¼šå­—å¹•æ ·å¼ */
        #subtitle {
            position: absolute;
            bottom: 10%;
            width: 100%;
            text-align: center;
            font-family: "Microsoft YaHei", sans-serif;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px #000000;
            pointer-events: none; /* é˜²æ­¢é®æŒ¡é¼ æ ‡ç‚¹å‡» */
            z-index: 20;
            transition: opacity 0.5s;
            opacity: 0; /* é»˜è®¤éšè— */
            padding: 0 20px;
            box-sizing: border-box;
        }
        #subtitle.visible {
            opacity: 1;
        }
		/* å³é”®èœå•å®¹å™¨ */
		#contextMenu {
			display: none; position: absolute; z-index: 1000; width: 220px;
			background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6); color: #eee;
			font-family: "Microsoft YaHei", sans-serif; font-size: 14px;
			overflow: hidden; user-select: none;
		}

		/* æ ‡é¢˜ */
		.menu-title {
			padding: 8px 15px; font-size: 12px; font-weight: bold; color: #aaa;
			background: rgba(0,0,0,0.4); pointer-events: none;
		}

		/* èœå•é¡¹ */
		.menu-item {
			padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			transition: background 0.2s; display: flex; justify-content: space-between; align-items: center;
		}
		.menu-item:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }

		/* åŠ¨ä½œåˆ—è¡¨å®¹å™¨ (å…³é”®ï¼šé»˜è®¤éšè—) */
		#motionListContainer {
			display: none; max-height: 250px; overflow-y: auto;
			background: rgba(0, 0, 0, 0.3); border-top: 1px solid rgba(255, 255, 255, 0.1);
		}

		/* åˆ—è¡¨é‡Œçš„åŠ¨ä½œé¡¹ */
		.motion-item {
			padding: 8px 15px 8px 30px; cursor: pointer; font-size: 13px; color: #ccc;
			border-bottom: 1px solid rgba(255,255,255,0.02);
		}
		.motion-item:hover { background: rgba(64, 158, 255, 0.2); color: #fff; }

		/* æ»šåŠ¨æ¡ç¾åŒ– */
		#motionListContainer::-webkit-scrollbar { width: 5px; }
		#motionListContainer::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="debug">Waiting for Python...</div>
    <div id="subtitle"></div>
	<div id="contextMenu">
		<div class="menu-title">æ§åˆ¶é¢æ¿</div>
		
		<div class="menu-item" id="btnToggleMotions">
			<span>ğŸ­ é€‰æ‹©åŠ¨ä½œ</span>
			<span id="arrowIcon">â–¼</span>
		</div>
		
		<div id="motionListContainer"></div>

		<div class="menu-title">æ¨¡å‹åˆ‡æ¢</div>
		<div id="modelSwitchContainer"></div>

		<div class="menu-title">ç³»ç»ŸåŠŸèƒ½</div>
		<div class="menu-item" onclick="window.playAllMotions()">â–¶ å¾ªç¯æ¼”ç¤º</div>
		
		<div id="exitContainer"></div>
	</div>

	<script>
            // ================= ç”¨æˆ·é…ç½®åŒºåŸŸ =================
            // åœ¨æ­¤åˆ—è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤æ¨¡å‹æ–‡ä»¶å¤¹åå³å¯
            const AVAILABLE_MODELS = ["lafei_4", "lafeiII_3"];

            // ================= å…¨å±€å˜é‡ =================
            window.model = null;
            window.voiceMap = {};
            window.voiceTextMap = {};
            window.randomVoicePool = [];
            window.targetX = 0;
            window.targetY = 0;
            window.lastPythonCommandTime = 0;
            let clickCount = 0;
            let subtitleTimer = null;
    
            // ================= æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =================
    
            // ä¿ç•™ç”¨æˆ·ç‰ˆæœ¬çš„å‡½æ•°
            function getMotionFadeInTime(groupName) {
                if (!window.model) return 0;
                const manager = window.model.internalModel.motionManager;
                const definitions = manager.definitions[groupName];
    
                if (!definitions || definitions.length === 0) {
                    return 500; // é»˜è®¤å€¼
                }
    
                const motionDef = definitions[0];
                
                let durationSec = motionDef.FadeInTime ?? motionDef.fadeInTime ?? manager.motionFadeInTime ?? 1.0;
                console.log(`[Config] åŠ¨ä½œç»„ ${groupName} çš„æ·¡å…¥æ—¶é—´: ${durationSec}ç§’`);
                return durationSec * 1000;
            }
    
            function showSubtitle(text, duration = 5000) {
                if (!text) return;
                const el = document.getElementById('subtitle');
                el.innerText = text;
                el.classList.add('visible');
    
                if (subtitleTimer) clearTimeout(subtitleTimer);
                subtitleTimer = setTimeout(() => {
                    el.classList.remove('visible');
                }, duration);
            }
    
            window.updateFocus = (dx, dy) => {
                if (window.model) window.model.focus(dx, dy);
                window.lastPythonCommandTime = Date.now();
                document.getElementById('debug').innerText = `Python: ${dx.toFixed(2)}, ${dy.toFixed(2)}`;
            };
    
            window.playMotionWithVoice = (groupName) => {
                return new Promise(async (resolve) => {
                    if (!window.model || !window.voiceMap) { resolve(); return; }
    
                    const fadeInTime = getMotionFadeInTime(groupName);
                    const delayMs = fadeInTime * 1;
    
                    const voicePath = window.voiceMap[groupName];
                    let audioObj = null;
    
                    if (voicePath) {
                        audioObj = new Audio(voicePath);
                        audioObj.preload = "auto";
                        await new Promise((resolveLoad) => {
                            if (audioObj.readyState >= 3) { resolveLoad(); } 
                            else {
                                audioObj.addEventListener('canplay', resolveLoad, { once: true });
                                audioObj.addEventListener('error', resolveLoad, { once: true });
                                setTimeout(resolveLoad, 2000);
                            }
                        });
                    }
					let voiceTask = Promise.resolve();
                    if (delayMs > 0 && audioObj) {
                        await new Promise(r => setTimeout(r, delayMs));
                    }
    
                    if (audioObj) {
                        voiceTask = window.model.speak(audioObj);
                    } else if (window.randomVoicePool && window.randomVoicePool.length > 0) {
                        const randomPath = window.randomVoicePool[Math.floor(Math.random() * window.randomVoicePool.length)];
                        voiceTask = window.model.speak(randomPath);
                    }
                    
                    const motionTask = new Promise((resolveMotion) => window.model.once('motionFinish', resolveMotion));
                    
                    if (!window.model.motion(groupName)) { resolve(); return; }
    
                    await Promise.all([motionTask, voiceTask]);
                    resolve();
                });
            };
			
			window.playMotion = (groupName) => {
				if (window.model) {
					if (window.model.internalModel.motionManager.motionGroups[groupName]) {
						console.log(`play motion ${groupName}`)
						window.model.motion(groupName);
					} else {
						console.log(`åŠ¨ä½œç»„ ${groupName} ä¸å­˜åœ¨ï¼Œå°è¯•æ’­æ”¾éšæœºåŠ¨ä½œ`);
						window.playRandomMotion();
					}
				}
			};
            
            window.playAllMotions = async () => {
                if (!window.model) return;
                const groups = Object.keys(window.model.internalModel.motionManager.motionGroups);
                for (const group of groups) {
                    await window.playMotionWithVoice(group);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            };
    
            // ================= Pixi & Live2D åˆå§‹åŒ– =================
    
            const app = new PIXI.Application({
                view: document.getElementById('canvas'),
                autoStart: true,
                resizeTo: window,
                transparent: true,
                backgroundAlpha: 0,
                antialias: true
            });
    
            // æ­¤å‡½æ•°å¯ç”± Python æˆ–æµè§ˆå™¨è‡ªå·±è°ƒç”¨
            window.initialize = async function(modelName, characterData) {
                console.log(`Initializing model: ${modelName}`);

                // å¦‚æœå·²æœ‰æ¨¡å‹ï¼Œå…ˆé”€æ¯
                if(window.model) {
                    app.stage.removeChild(window.model);
                    window.model.destroy();
                    window.model = null;
                }
    
                // 1. è®¾ç½®æ•°æ®æ˜ å°„
                const SOUND_ROOT = `${modelName}/sound/`;
                window.voiceMap = Object.entries(characterData.voiceMap).reduce((acc, [key, value]) => {
                    acc[key] = SOUND_ROOT + value;
                    return acc;
                }, {});
                window.voiceTextMap = characterData.voiceTextMap;
                window.randomVoicePool = Object.values(window.voiceMap).slice(0, 4);
    
                // 2. åŠ è½½æ¨¡å‹
                const MODEL_JSON_URL = `${modelName}/${modelName}.model3.json`;
                const model = await PIXI.live2d.Live2DModel.from(MODEL_JSON_URL, {
                    autoInteract: false,
                    autoUpdate: true
                });
    
                model.interactive = true;
                model.blink = true;
                model.lipSync = true;
                
                // 3. é‡å†™ speak æ–¹æ³•
                model.speak = function(source) {
                    return new Promise((resolve) => {
                        if (!source) { resolve(); return; }
                        if (this._currentAudio) this._currentAudio.pause();
    
                        const audio = (typeof source === 'string') ? new Audio(source) : source;
                        this._currentAudio = audio;
    
                        audio.onended = () => resolve();
                        audio.onerror = (e) => { console.warn(`[Audio] æ’­æ”¾å¼‚å¸¸`, e); resolve(); };
                        
                        const playPromise = audio.play();
                        if (playPromise) {
                            playPromise.catch(error => {
                                if (error.name !== 'AbortError') console.warn("æ’­æ”¾ä¸­æ–­:", error);
                                resolve();
                            });
                        }
    
                        const srcPath = audio.src || (typeof source === 'string' ? source : "");
                        if (srcPath) {
                            const filename = decodeURIComponent(srcPath.split('/').pop());
                            const text = window.voiceTextMap[filename];
                            if (text) showSubtitle(text, audio.duration * 1000 + 500);
                        }
                    });
                };
    
                // 4. è®¾ç½®äº¤äº’äº‹ä»¶ (ä¿ç•™ç”¨æˆ·çš„ console.log)
                const groups = Object.keys(model.internalModel.motionManager.motionGroups);
                model.on('pointertap', (event) => {
                    if (event.data.button !== 0) return;
                    const currentGroup = groups[clickCount % groups.length];
                    window.playMotionWithVoice(currentGroup);
                    clickCount++;
    				console.log(`ç‚¹å‡»è®¡æ•°: ${clickCount}, ä¸‹ä¸€ä¸ªåŠ¨ä½œ: ${groups[clickCount % groups.length]}`);
                });
    
                app.stage.addChild(model);
                window.model = model;
    
                fitLayout();
                window.onresize = fitLayout;
            }
            
            function fitLayout() {
                if (!window.model) return;
                const modelHeight = window.model.internalModel.height;
                if (!modelHeight) return;
    
                const scale = (window.innerHeight * 0.8) / modelHeight;
                window.model.scale.set(scale);
                window.model.x = window.innerWidth / 2;
                window.model.y = window.innerHeight / 2 + 50;
                window.model.anchor.set(0.5, 0.5);
            }
    
            // ================= å¯åŠ¨é€»è¾‘ =================
            
            (async function main() {
                await new Promise(resolve => setTimeout(resolve, 100));
    
                if (window.isDesktop) {
                    console.log("åœ¨æ¡Œé¢æ¨¡å¼ä¸‹è¿è¡Œï¼Œç­‰å¾… Python åˆå§‹åŒ–...");
                    document.getElementById('debug').innerText = 'Ready for Python...';
                } else {
                    console.log("åœ¨æµè§ˆå™¨æ¨¡å¼ä¸‹è¿è¡Œï¼Œè‡ªè¡Œåˆå§‹åŒ–...");
                    document.getElementById('debug').innerText = 'Browser Mode';
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const modelFromUrl = urlParams.get('model');
                    
                    const modelToLoad = AVAILABLE_MODELS.includes(modelFromUrl) ? modelFromUrl : AVAILABLE_MODELS[0];

                    console.log(`Browser mode: loading model "${modelToLoad}"`);
                    const CHARACTER_DATA_URL = `${modelToLoad}/character_data.json`;
                    
                    try {
                        const response = await fetch(CHARACTER_DATA_URL);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const characterData = await response.json();
                        window.initialize(modelToLoad, characterData);
                    } catch (error) {
                        console.error("åœ¨æµè§ˆå™¨æ¨¡å¼ä¸‹åŠ è½½è§’è‰²æ•°æ®å¤±è´¥:", error);
                        alert("åŠ è½½è§’è‰²é…ç½®å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æ˜¯é€šè¿‡ http server è®¿é—®ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰“å¼€ file://... URLã€‚");
                    }
                }
            })();
    
    
            // ================= å³é”®èœå•é€»è¾‘ =================
            const menu = document.getElementById('contextMenu');
            const motionContainer = document.getElementById('motionListContainer');
            const modelSwitchContainer = document.getElementById('modelSwitchContainer');
            const btnToggle = document.getElementById('btnToggleMotions');
            const arrowIcon = document.getElementById('arrowIcon');
            const exitContainer = document.getElementById('exitContainer');
    
            window.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                
                // --- åŠ¨æ€ç”Ÿæˆæ¨¡å‹åˆ‡æ¢èœå• ---
                modelSwitchContainer.innerHTML = ''; // æ¸…ç©ºæ—§èœå•
                AVAILABLE_MODELS.forEach(modelName => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.innerText = `â†’ ${modelName}`;
                    
                    // å¦‚æœæ˜¯å½“å‰æ¨¡å‹ï¼Œåˆ™é«˜äº®(å¯é€‰)
                    <!-- if (window.model && window.model.name.startsWith(modelName)) { -->
                         <!-- item.style.background = 'rgba(64, 158, 255, 0.2)'; -->
                    <!-- } -->

                    item.onclick = () => {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¨¡å‹ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                        <!-- if (window.model && window.model.name.startsWith(modelName)) return; -->

                        if (window.isDesktop) {
                            // æ¡Œé¢æ¨¡å¼: å‘é€æŒ‡ä»¤ç»™ Python
                            document.title = "CMD:RELOAD:" + modelName;
                        } else {
                            // æµè§ˆå™¨æ¨¡å¼: é€šè¿‡ URL å‚æ•°åˆ·æ–°é¡µé¢
                            window.location.href = window.location.pathname + '?model=' + modelName;
                        }
                    };
                    modelSwitchContainer.appendChild(item);
                });


                // --- åŠ¨æ€ç”ŸæˆåŠ¨ä½œåˆ—è¡¨ ---
                if (window.model) {
                    motionContainer.innerHTML = '';
                    const groups = Object.keys(window.model.internalModel.motionManager.motionGroups);
                    
                    groups.forEach(groupName => {
                        const item = document.createElement('div');
                        item.className = 'motion-item';
                        item.innerText = groupName;
                        item.onclick = (ev) => {
                            ev.stopPropagation();
                            window.playMotionWithVoice(groupName);
                            menu.style.display = 'none';
                        };
                        motionContainer.appendChild(item);
                    });
                }
    
                motionContainer.style.display = 'none';
                arrowIcon.innerText = 'â–¼';
    
                // --- å¤„ç†é€€å‡ºæŒ‰é’® ---
                exitContainer.innerHTML = '';
                if (window.isDesktop) {
                    const exitItem = document.createElement('div');
                    exitItem.className = 'menu-item';
                    exitItem.style.color = '#ff6b6b';
                    exitItem.innerText = 'âœ– é€€å‡ºç¨‹åº';
                    exitItem.onclick = () => { document.title = "CMD:QUIT"; };
                    exitContainer.appendChild(exitItem);
                }
    
                // --- è®¡ç®—èœå•ä½ç½®å¹¶æ˜¾ç¤º ---
                let x = e.clientX, y = e.clientY;
                if (x + 220 > window.innerWidth) x = window.innerWidth - 220;
                if (y + 300 > window.innerHeight) y = window.innerHeight - 300; // é¢„ä¼°ä¸€ä¸ªé«˜åº¦
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                menu.style.display = 'block';
            });
    
            btnToggle.onclick = function(e) {
                e.stopPropagation();
                const isHidden = motionContainer.style.display === 'none';
                motionContainer.style.display = isHidden ? 'block' : 'none';
                arrowIcon.innerText = isHidden ? 'â–²' : 'â–¼';
            };
    
            window.addEventListener('click', () => {
                menu.style.display = 'none';
            });
    </script>
</body>
</html>